name: ๐ Code Review & Build Check

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  # Job 1: ะัะพะฒะตัะบะฐ ะบะพะผะฟะธะปััะธะธ
  build-check:
    name: ๐จ ะัะพะฒะตัะบะฐ ะบะพะผะฟะธะปััะธะธ
    runs-on: macos-latest
    timeout-minutes: 20
    outputs:
      build-status: ${{ steps.build.outcome }}

    steps:
      - name: ๐ฅ Checkout ะบะพะดะฐ
        uses: actions/checkout@v4

      - name: ๐พ ะะตั SPM ะทะฐะฒะธัะธะผะพััะตะน
        uses: actions/cache@v4
        with:
          path: |
            .build
            ~/Library/Developer/Xcode/DerivedData
          key: ${{ runner.os }}-spm-${{ hashFiles('**/Package.resolved') }}
          restore-keys: |
            ${{ runner.os }}-spm-

      - name: ๐ ะะฝัะพัะผะฐัะธั ะพ ััะตะดะต
        run: |
          echo "Xcode: $(xcodebuild -version)"
          echo "Swift: $(swift --version)"
          echo "macOS: $(sw_vers -productVersion)"

      - name: ๐จ ะกะฑะพัะบะฐ ะฟัะพะตะบัะฐ
        id: build
        continue-on-error: true
        run: |
          if [ -f "Package.swift" ]; then
            echo "๐ฆ Swift Package ะพะฑะฝะฐััะถะตะฝ"
            swift build
          elif ls *.xcworkspace 1> /dev/null 2>&1; then
            WORKSPACE=$(ls *.xcworkspace | head -n 1)
            SCHEME=$(xcodebuild -workspace "$WORKSPACE" -list | grep -A 1 "Schemes:" | tail -n 1 | xargs)
            echo "๐จ ะกะพะฑะธัะฐั workspace: $WORKSPACE, ััะตะผะฐ: $SCHEME"
            xcodebuild -workspace "$WORKSPACE" -scheme "$SCHEME" \
              -destination "platform=iOS Simulator,name=iPhone 16" \
              -configuration Debug clean build
          elif ls *.xcodeproj 1> /dev/null 2>&1; then
            PROJECT=$(ls *.xcodeproj | head -n 1)
            SCHEME=$(xcodebuild -project "$PROJECT" -list | grep -A 1 "Schemes:" | tail -n 1 | xargs)
            echo "๐จ ะกะพะฑะธัะฐั ะฟัะพะตะบั: $PROJECT, ััะตะผะฐ: $SCHEME"
            xcodebuild -project "$PROJECT" -scheme "$SCHEME" \
              -destination "platform=iOS Simulator,name=iPhone 16" \
              -configuration Debug clean build
          else
            echo "โ Swift ะฟัะพะตะบั ะฝะต ะฝะฐะนะดะตะฝ"
            exit 1
          fi

      - name: ๐ ะะตะทัะปััะฐั ัะฑะพัะบะธ
        run: |
          if [ "${{ steps.build.outcome }}" == "success" ]; then
            echo "โ ะัะพะตะบั ััะฟะตัะฝะพ ัะบะพะผะฟะธะปะธัะพะฒะฐะฝ!"
          else
            echo "โ ะัะธะฑะบะฐ ะบะพะผะฟะธะปััะธะธ!"
            exit 1
          fi

  # Job 2: ะะปะพะฝะธัะพะฒะฐะฝะธะต Code Review Tools
  setup-tools:
    name: ๐๏ธ ะะพะดะณะพัะพะฒะบะฐ ะธะฝััััะผะตะฝัะพะฒ
    runs-on: macos-latest

    steps:
      - name: ๐ฅ ะะปะพะฝะธัะพะฒะฐะฝะธะต Code Review Tools
        run: |
          git clone https://github.com/${{ github.repository_owner }}/mesimtesto.git tools
          cd tools
          echo "โ ะะฝััััะผะตะฝัั ะบะปะพะฝะธัะพะฒะฐะฝั"

      - name: ๐จ ะกะฑะพัะบะฐ Code Review Tools
        run: |
          cd tools
          swift build -c release
          echo "โ ะะฝััััะผะตะฝัั ัะพะฑัะฐะฝั"

      - name: ๐พ ะกะพััะฐะฝะตะฝะธะต ัะพะฑัะฐะฝะฝัั ะธะฝััััะผะตะฝัะพะฒ
        uses: actions/upload-artifact@v4
        with:
          name: code-review-tools
          path: tools/.build/release/
          retention-days: 1

  # Job 3: ะัะพะฒะตัะบะฐ ััะธะปั ะบะพะดะฐ (SwiftLint)
  style-check:
    name: ๐จ ะัะพะฒะตัะบะฐ ััะธะปั ะบะพะดะฐ
    needs: setup-tools
    runs-on: macos-latest

    steps:
      - name: ๐ฅ Checkout ะบะพะดะฐ
        uses: actions/checkout@v4

      - name: ๐ฅ ะะฐะณััะทะบะฐ ะธะฝััััะผะตะฝัะพะฒ
        uses: actions/download-artifact@v4
        with:
          name: code-review-tools
          path: tools

      - name: ๐ง ะฃััะฐะฝะพะฒะบะฐ SwiftLint
        run: |
          brew install swiftlint
          echo "SwiftLint ะฒะตััะธั: $(swiftlint version)"

      - name: ๐จ ะะฐะฟััะบ ะฟัะพะฒะตัะบะธ ััะธะปั
        id: style-check
        continue-on-error: true
        run: |
          chmod +x tools/swift-style-check
          tools/swift-style-check . --format json --output style-report.json || true

      - name: ๐ ะะตะทัะปััะฐัั ะฟัะพะฒะตัะบะธ ััะธะปั
        if: always()
        run: |
          if [ -f "style-report.json" ]; then
            echo "๐ ะััะตั ัะพะทะดะฐะฝ"
            cat style-report.json | jq '.summary'

            # ะะพะดััะตั ะฟัะพะฑะปะตะผ
            ERRORS=$(cat style-report.json | jq '.summary.errors')
            WARNINGS=$(cat style-report.json | jq '.summary.warnings')

            echo "โ ะัะธะฑะพะบ: $ERRORS"
            echo "โ๏ธ  ะัะตะดัะฟัะตะถะดะตะฝะธะน: $WARNINGS"

            # ะกะพััะฐะฝัะตะผ ะดะปั ะพัะฟัะฐะฒะบะธ ะฝะฐ backend
            echo "STYLE_ERRORS=$ERRORS" >> $GITHUB_ENV
            echo "STYLE_WARNINGS=$WARNINGS" >> $GITHUB_ENV
          else
            echo "โ๏ธ ะััะตั ะฝะต ัะพะทะดะฐะฝ"
          fi

      - name: ๐พ ะกะพััะฐะฝะตะฝะธะต ะพััะตัะฐ
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: style-report
          path: style-report.json
          if-no-files-found: ignore

  # Job 4: ะะพะธัะบ ะผะตััะฒะพะณะพ ะบะพะดะฐ (Periphery)
  dead-code-check:
    name: ๐๏ธ ะะพะธัะบ ะฝะตะธัะฟะพะปัะทัะตะผะพะณะพ ะบะพะดะฐ
    needs: setup-tools
    runs-on: macos-latest

    steps:
      - name: ๐ฅ Checkout ะบะพะดะฐ
        uses: actions/checkout@v4

      - name: ๐ฅ ะะฐะณััะทะบะฐ ะธะฝััััะผะตะฝัะพะฒ
        uses: actions/download-artifact@v4
        with:
          name: code-review-tools
          path: tools

      - name: ๐ง ะฃััะฐะฝะพะฒะบะฐ Periphery
        run: |
          brew install peripheryapp/periphery/periphery
          echo "Periphery ะฒะตััะธั: $(periphery version)"

      - name: ๐๏ธ ะะฐะฟััะบ ะฟะพะธัะบะฐ ะผะตััะฒะพะณะพ ะบะพะดะฐ
        id: dead-code
        continue-on-error: true
        run: |
          chmod +x tools/swift-dead-code

          # ะัะตะผ ะฟัะพะตะบั
          if ls *.xcworkspace 1> /dev/null 2>&1; then
            PROJECT=$(ls *.xcworkspace | head -n 1)
          elif ls *.xcodeproj 1> /dev/null 2>&1; then
            PROJECT=$(ls *.xcodeproj | head -n 1)
          else
            echo "โ๏ธ Xcode ะฟัะพะตะบั ะฝะต ะฝะฐะนะดะตะฝ, ะฟัะพะฟััะบะฐะตะผ ะฟัะพะฒะตัะบั"
            exit 0
          fi

          tools/swift-dead-code "$PROJECT" --format json --output dead-code-report.json || true

      - name: ๐ ะะตะทัะปััะฐัั ะฟะพะธัะบะฐ ะผะตััะฒะพะณะพ ะบะพะดะฐ
        if: always()
        run: |
          if [ -f "dead-code-report.json" ]; then
            echo "๐ ะััะตั ัะพะทะดะฐะฝ"
            cat dead-code-report.json | jq '.summary'

            DEAD_CODE_COUNT=$(cat dead-code-report.json | jq '.summary.warnings')
            echo "๐๏ธ ะะตะธัะฟะพะปัะทัะตะผัั ัะปะตะผะตะฝัะพะฒ: $DEAD_CODE_COUNT"
            echo "DEAD_CODE_COUNT=$DEAD_CODE_COUNT" >> $GITHUB_ENV
          else
            echo "โ๏ธ ะััะตั ะฝะต ัะพะทะดะฐะฝ ะธะปะธ ะฟัะพะตะบั ะฝะต ะฟะพะดะดะตัะถะธะฒะฐะตััั"
          fi

      - name: ๐พ ะกะพััะฐะฝะตะฝะธะต ะพััะตัะฐ
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: dead-code-report
          path: dead-code-report.json
          if-no-files-found: ignore

  # Job 5: ะัะพะฒะตัะบะฐ ััะตัะตะบ ะฟะฐะผััะธ
  memory-check:
    name: ๐พ ะัะพะฒะตัะบะฐ ััะตัะตะบ ะฟะฐะผััะธ
    needs: setup-tools
    runs-on: macos-latest

    steps:
      - name: ๐ฅ Checkout ะบะพะดะฐ
        uses: actions/checkout@v4

      - name: ๐ฅ ะะฐะณััะทะบะฐ ะธะฝััััะผะตะฝัะพะฒ
        uses: actions/download-artifact@v4
        with:
          name: code-review-tools
          path: tools

      - name: ๐พ ะะฐะฟััะบ ะฟัะพะฒะตัะบะธ ะฟะฐะผััะธ
        id: memory-check
        continue-on-error: true
        run: |
          chmod +x tools/swift-memory-check
          tools/swift-memory-check . --static-analysis --format json --output memory-report.json || true

      - name: ๐ ะะตะทัะปััะฐัั ะฟัะพะฒะตัะบะธ ะฟะฐะผััะธ
        if: always()
        run: |
          if [ -f "memory-report.json" ]; then
            echo "๐ ะััะตั ัะพะทะดะฐะฝ"
            cat memory-report.json | jq '.summary'

            MEMORY_ERRORS=$(cat memory-report.json | jq '.summary.errors')
            MEMORY_WARNINGS=$(cat memory-report.json | jq '.summary.warnings')

            echo "โ ะัะธะฑะพะบ: $MEMORY_ERRORS"
            echo "โ๏ธ  ะัะตะดัะฟัะตะถะดะตะฝะธะน: $MEMORY_WARNINGS"

            echo "MEMORY_ERRORS=$MEMORY_ERRORS" >> $GITHUB_ENV
            echo "MEMORY_WARNINGS=$MEMORY_WARNINGS" >> $GITHUB_ENV
          else
            echo "โ๏ธ ะััะตั ะฝะต ัะพะทะดะฐะฝ"
          fi

      - name: ๐พ ะกะพััะฐะฝะตะฝะธะต ะพััะตัะฐ
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: memory-report
          path: memory-report.json
          if-no-files-found: ignore

  # Job 6: ะกะฒะพะดะฝัะน ะพััะตั ะธ ะพัะฟัะฐะฒะบะฐ ะฝะฐ backend
  final-report:
    name: ๐ ะกะฒะพะดะฝัะน ะพััะตั
    needs: [build-check, style-check, dead-code-check, memory-check]
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: ๐ฅ Checkout ะบะพะดะฐ
        uses: actions/checkout@v4

      - name: ๐ฅ ะะฐะณััะทะบะฐ ะฒัะตั ะพััะตัะพะฒ
        uses: actions/download-artifact@v4
        with:
          path: reports

      - name: ๐ ะกะพะทะดะฐะฝะธะต ัะฒะพะดะฝะพะณะพ ะพััะตัะฐ
        run: |
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo "โ          ๐ ะกะะะะะซะ ะะขะงะะข CODE REVIEW                  โ"
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo ""
          echo "๐ ะะตะฟะพะทะธัะพัะธะน: ${{ github.repository }}"
          echo "๐ ะะตัะบะฐ: ${{ github.ref_name }}"
          echo "๐ค ะะฒัะพั: ${{ github.actor }}"
          echo "๐ Commit: ${{ github.sha }}"
          echo ""

          # ะกัะฐััั ัะฑะพัะบะธ
          if [ "${{ needs.build-check.outputs.build-status }}" == "success" ]; then
            echo "โ ๐จ ะกะฑะพัะบะฐ: ะฃะกะะะจะะ"
          else
            echo "โ ๐จ ะกะฑะพัะบะฐ: ะะะะะะะะะ"
          fi

          # ะัะพะฒะตัะบะฐ ััะธะปั
          if [ -f "reports/style-report/style-report.json" ]; then
            STYLE_ERRORS=$(cat reports/style-report/style-report.json | jq -r '.summary.errors // 0')
            STYLE_WARNINGS=$(cat reports/style-report/style-report.json | jq -r '.summary.warnings // 0')
            echo "๐จ ะกัะธะปั ะบะพะดะฐ: $STYLE_ERRORS ะพัะธะฑะพะบ, $STYLE_WARNINGS ะฟัะตะดัะฟัะตะถะดะตะฝะธะน"
          else
            echo "โ๏ธ  ๐จ ะกัะธะปั ะบะพะดะฐ: ะพััะตั ะฝะตะดะพัััะฟะตะฝ"
          fi

          # ะะตััะฒัะน ะบะพะด
          if [ -f "reports/dead-code-report/dead-code-report.json" ]; then
            DEAD_CODE=$(cat reports/dead-code-report/dead-code-report.json | jq -r '.summary.warnings // 0')
            echo "๐๏ธ  ะะตะธัะฟะพะปัะทัะตะผัะน ะบะพะด: $DEAD_CODE ัะปะตะผะตะฝัะพะฒ"
          else
            echo "โ๏ธ  ๐๏ธ  ะะตะธัะฟะพะปัะทัะตะผัะน ะบะพะด: ะพััะตั ะฝะตะดะพัััะฟะตะฝ"
          fi

          # ะฃัะตัะบะธ ะฟะฐะผััะธ
          if [ -f "reports/memory-report/memory-report.json" ]; then
            MEM_ERRORS=$(cat reports/memory-report/memory-report.json | jq -r '.summary.errors // 0')
            MEM_WARNINGS=$(cat reports/memory-report/memory-report.json | jq -r '.summary.warnings // 0')
            echo "๐พ ะฃัะตัะบะธ ะฟะฐะผััะธ: $MEM_ERRORS ะพัะธะฑะพะบ, $MEM_WARNINGS ะฟัะตะดัะฟัะตะถะดะตะฝะธะน"
          else
            echo "โ๏ธ  ๐พ ะฃัะตัะบะธ ะฟะฐะผััะธ: ะพััะตั ะฝะตะดะพัััะฟะตะฝ"
          fi

          echo ""
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"

      - name: ๐ค ะะพะดะณะพัะพะฒะบะฐ JSON ะดะปั ะพัะฟัะฐะฒะบะธ ะฝะฐ backend
        id: prepare-json
        run: |
          # ะกะพะทะดะฐะตะผ JSON ัะพ ะฒัะตะผะธ ัะตะทัะปััะฐัะฐะผะธ
          cat > final-report.json <<EOF
          {
            "repository": "${{ github.repository }}",
            "branch": "${{ github.ref_name }}",
            "commit": "${{ github.sha }}",
            "author": "${{ github.actor }}",
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "build_status": "${{ needs.build-check.outputs.build-status }}",
            "reports": {
              "style": $(cat reports/style-report/style-report.json 2>/dev/null || echo 'null'),
              "dead_code": $(cat reports/dead-code-report/dead-code-report.json 2>/dev/null || echo 'null'),
              "memory": $(cat reports/memory-report/memory-report.json 2>/dev/null || echo 'null')
            }
          }
          EOF

          echo "๐ JSON ะพััะตั ัะพะทะดะฐะฝ:"
          cat final-report.json | jq '.'

      - name: ๐ค ะัะฟัะฐะฒะบะฐ ะฝะฐ backend (TODO)
        run: |
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo "๐ค ะะขะะะะะะ ะะ BACKEND"
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo ""
          echo "โ๏ธ  Backend URL ะฝะต ะฝะฐัััะพะตะฝ"
          echo ""
          echo "๐ก ะงัะพะฑั ะพัะฟัะฐะฒะปััั ัะตะทัะปััะฐัั ะฝะฐ ะฒะฐั backend:"
          echo "   1. ะะพะฑะฐะฒััะต secret BACKEND_URL ะฒ ะฝะฐัััะพะนะบะฐั ัะตะฟะพะทะธัะพัะธั"
          echo "   2. ะะฐัะบะพะผะผะตะฝัะธััะนัะต ะบะพะด ะฝะธะถะต"
          echo ""
          echo "ะัะธะผะตั ะบะพะดะฐ ะดะปั ะพัะฟัะฐะฒะบะธ:"
          echo "  curl -X POST \$BACKEND_URL \\"
          echo "    -H 'Content-Type: application/json' \\"
          echo "    -d @final-report.json"
          echo ""

          # TODO: ะะฐัะบะพะผะผะตะฝัะธััะนัะต ะบะพะณะดะฐ backend ะฑัะดะตั ะณะพัะพะฒ
          # if [ -n "${{ secrets.BACKEND_URL }}" ]; then
          #   curl -X POST ${{ secrets.BACKEND_URL }} \
          #     -H "Content-Type: application/json" \
          #     -H "Authorization: Bearer ${{ secrets.BACKEND_TOKEN }}" \
          #     -d @final-report.json
          # fi

      - name: ๐พ ะกะพััะฐะฝะตะฝะธะต ัะธะฝะฐะปัะฝะพะณะพ ะพััะตัะฐ
        uses: actions/upload-artifact@v4
        with:
          name: final-report
          path: final-report.json
